<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <style>
        body {
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-top: 1%;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding-top: 6px;
            padding-right: 1px;
            overflow-y: scroll;
            height: calc(100vh - 10vh);
            height: -webkit-calc(100vh - 10vh);
            height: -moz-calc(100vh - 10vh);
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    <title>Room-Temp</title>
    <meta http-equiv="refresh" content="180">
</head>
<body>

<div class="row">
    <div class="col-sm-9">
        <!-- Tab panes -->
        {% for room in rooms %}
        <div id="content_{{ room }}" class="table-responsive tabcontent">
            <table class="table table-bordered">
                <tr>
                    <th style="width:20%">Temperature</th>
                    <th style="width:20%">Humidity</th>
                    <th>Date</th>
                    <th style="width:20%">Time</th>
                </tr>
                {% for data in rooms[room] %}
                <tr>
                    <td>{{ data['temperature'] }}Â°C</td>
                    <td>{{ data['humidity'] }}%</td>
                    <td>{{ data['date'] }}</td>
                    <td>{{ data['time'] }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endfor %}
    </div>

    <div class="col-sm-3">
        <!-- Nav tabs -->
        <div class="btn-group">
            {% for room in rooms %}
            <button class="btn btn-primary" onclick="openTab(this, '{{ room }}')" id="button_{{ room }}">{{ room }}</button>
            {% endfor %}
        </div>
        <br>
        <br>
        <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default">Limit</span>
            <input type="number" class="form-control" aria-label="Sizing example input"
                   aria-describedby="inputGroup-sizing-default" id="limit_input" value="{{ limit }}"/>
            <button class="btn btn-secondary" onclick="setLimit()">Set</button>
            <button class="btn btn-warning" onclick="setLimit(24)">Reset</button>
        </div>
    </div>

</div>

</body>
</html>

<script>
    // Set active tab to the cookie value
    document.getElementById(getCookie("activeTab")).click();

    // Reload the page with current limit
    limit = getCookie("limit")
    if (limit !== null && limit !== document.getElementById("limit_input").value) {
        document.location.search = "limit=" + limit;
    }

    function openTab(button, roomName) {
        // Declare all variables
        let i, all_elements;

        // Get all elements
        all_elements = document.querySelectorAll("*");
        console.log(all_elements);
        for (i = 0; i < all_elements.length; i++) {
            if ((all_elements[i].id).includes("content_")) {
                all_elements[i].style.display = "none";
            }
        }

        // Get all elements with class="tablinks" and remove the class "active"
        all_elements = document.querySelectorAll("*");
        for (i = 0; i < all_elements.length; i++) {
            if ((all_elements[i].id).includes("button_")) {
                all_elements[i].className = all_elements[i].className.replace(" active", "");
            }
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById("content_" + roomName).style.display = "block";
        button.classList.add("active");

        // Set cookie for active tab
        setCookie("activeTab", "button_" + roomName, 30);
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function setLimit(limit) {
        if (limit === undefined) {
            limit = document.getElementById("limit_input").value;
        }
        let reg = new RegExp('^\\d+$');
        if (!reg.test(limit)) {
            limit = 24;
        }

        // Set cookie for active tab
        setCookie("limit", limit, 30);

        // Reload the page with current limit
        document.location.search = "limit=" + limit;
    }
</script>