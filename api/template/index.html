<!DOCTYPE html>
<html lang="en">
<head>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <!-- ChartJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <style>
        body {
            width: 95%;
            margin-left: auto;
            margin-right: auto;
            margin-top: 5%;
        }

        .form-control {
            max-width: 59px;
        }

        .btn-group button {
            min-width: 80px;
        }

        .span-fixed {
            min-width: 120px;
        }

        .col-lg-3 {
            padding-top: 5vh;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding-top: 6px;
            padding-right: 1px;
            height: calc(100vh - 30vh);
            height: -webkit-calc(100vh - 30vh);
            height: -moz-calc(100vh - 30vh);
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    <title>Room-Temp</title>
</head>
<body>

<div class="row">
    <div class="col-lg-9">
        <!-- Nav tabs -->
        <div class="input-group">
            <div class="dropdown" style="padding-right: 1%">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Rooms
                </button>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton1">
                    {% for room in rooms %}
                    <li><a onclick="openRoom(this, '{{ room }}')" id="room_btn_{{ room }}" class="dropdown-item">{{ room
                        }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary active" onclick="openTab(this, 'chart_')" id="tab_btn_chart">Dashboard
                </button>
                <button class="btn btn-primary" onclick="openTab(this, 'table_')" id="tab_btn_table">Table</button>
            </div>
        </div>

        <!-- Tab panes -->
        {% for room in rooms %}
        <div id="chart_{{ room }}" class="tabcontent">
            <p style="text-align: center; font-weight: bold">Room: {{ room }}</p>
            <canvas id="dash_{{ room }}"></canvas>
        </div>

        <div id="table_{{ room }}" class="table-responsive tabcontent">
            <p style="text-align: center; font-weight: bold">Room: {{ room }}</p>
            <table class="table table-bordered">
                <tr>
                    <th style="width:20%">Temperature</th>
                    <th style="width:20%">Humidity</th>
                    <th>Date</th>
                    <th style="width:20%">Time</th>
                </tr>
                {% for data in rooms[room] %}
                <tr>
                    <td>{{ data['temperature'] }}Â°C</td>
                    <td>{{ data['humidity'] }}%</td>
                    <td>{{ data['date'] }}</td>
                    <td>{{ data['time'] }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endfor %}
    </div>

    <div class="col-lg-3">
        <div class="input-group">
            <span class="input-group-text span-fixed">Auto Refresh</span>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" id="auto_refresh_enabled"
                        onclick="toggleAutoRefresh('true')">Enable
                </button>
                <button type="button" class="btn btn-primary" id="auto_refresh_disabled"
                        onclick="toggleAutoRefresh('false')">Disable
                </button>
            </div>
        </div>
        <br>
        <div class="input-group">
            <span class="input-group-text" id="inputGroup-sizing-default">Limit</span>
            <input type="number" class="form-control" id="limit_input" value="{{ limit }}"/>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="setLimit()">Set</button>
                <button class="btn btn-warning" onclick="setLimit(24)">Reset</button>
            </div>
        </div>
    </div>

</div>

</body>
</html>

<script>
    // Set active tab to the cookie value
    document.getElementById("room_btn_" + getCookie("activeRoom")).click();

    // Reload the page with current limit
    limit = getCookie("limit");
    if (limit !== null && limit !== document.getElementById("limit_input").value) {
        document.location.search = "limit=" + limit;
    }

    let refreshInterval;
    autorefresh = getCookie("autoRefresh");
    if (autorefresh == null) {
        autorefresh = "true";
        setCookie("autoRefresh", "true", 30);
    }
    toggleAutoRefresh(autorefresh);

    const rooms = {{ rooms | tojson }};
    // Get all elements
    all_elements = document.querySelectorAll("*");
    for (let room in rooms) {
        let temps = []
        let humis = []
        let dates = []
        for (let j = rooms[room].length - 1; j >= 0; j--) {
            temps.push(rooms[room][j]['temperature']);
            humis.push(rooms[room][j]['humidity']);
            let date_time = rooms[room][j]['date'].split(",")[0] + " - " + rooms[room][j]['time'];
            dates.push(date_time);
        }
        for (let j = 0; j < all_elements.length; j++) {
            if ((all_elements[j].id).includes("dash_" + room)) {
                new Chart(all_elements[j], {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            data: temps,
                            label: "Temperature",
                            borderColor: "#f30052",
                            fill: false
                        }, {
                            data: humis,
                            label: "Humidity",
                            borderColor: "#3e95cd",
                            fill: false
                        }

                        ]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                });
            }
        }
    }

    function openRoom(button, roomName) {
        // Declare all variables
        let i, all_elements;

        // Get all elements
        all_elements = document.querySelectorAll("*");
        // Get all content and hide them
        for (i = 0; i < all_elements.length; i++) {
            if (all_elements[i].id.includes("chart_") || all_elements[i].id.includes("table_")) {
                all_elements[i].style.display = "none";
            }
        }

        // Get all buttons and remove the class "active"
        for (i = 0; i < all_elements.length; i++) {
            if ((all_elements[i].id).includes("room_btn")) {
                all_elements[i].classList.remove("active");
            }
        }

        let to_be_deactivate_btn = document.getElementById("tab_btn_table");
        to_be_deactivate_btn.classList.remove("active");
        let to_be_active = document.getElementById("tab_btn_chart");
        to_be_active.classList.add("active");

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById("chart_" + roomName).style.display = "block";
        button.classList.add("active");

        // Set cookie for active tab
        setCookie("activeRoom", roomName, 30);
    }

    function openTab(button, tab) {
        let roomName = getCookie("activeRoom");
        let to_be_deactivate, to_be_deactivate_btn;
        if (tab === "chart_") {
            to_be_deactivate = document.getElementById("table_" + roomName);
            to_be_deactivate_btn = document.getElementById("tab_btn_table");
        } else if (tab === "table_") {
            to_be_deactivate = document.getElementById("chart_" + roomName);
            to_be_deactivate_btn = document.getElementById("tab_btn_chart");
        }
        to_be_deactivate.style.display = "none";
        to_be_deactivate_btn.classList.remove("active");

        let activeTab = tab + roomName;
        let to_be_active = document.getElementById(activeTab);
        to_be_active.style.display = "block";
        button.classList.add("active");
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function setLimit(limit) {
        if (limit === undefined) {
            limit = document.getElementById("limit_input").value;
        }
        let reg = new RegExp('^\\d+$');
        if (!reg.test(limit)) {
            limit = 24;
        }

        // Set cookie for active tab
        setCookie("limit", limit, 30);

        // Reload the page with current limit
        document.location.search = "limit=" + limit;
    }

    function toggleAutoRefresh(refresh) {
        setCookie('autoRefresh', refresh, 30);
        let button_enable = document.getElementById("auto_refresh_enabled");
        let button_disable = document.getElementById("auto_refresh_disabled");

        if (refresh === "true") {
            button_enable.classList.add("active");
            button_disable.classList.remove("active");
            refreshInterval = setInterval(function () {
                window.location.reload();
            }, 180000);
        } else if (refresh === "false") {
            if (refreshInterval !== null) {
                clearInterval(refreshInterval);
            }
            button_enable.classList.remove("active");
            button_disable.classList.add("active");
        }
    }
</script>